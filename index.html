<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Content Generator & Publisher</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; background:#f7f7f9; color:#222 }
    form { background:#fff; padding:16px; border-radius:8px; max-width:800px; box-shadow:0 2px 8px rgba(0,0,0,0.06) }
    input, select, textarea, button { width:100%; padding:10px; margin:8px 0; box-sizing:border-box }
    button { background:#007bff; color:#fff; border:none; cursor:pointer; border-radius:6px; }
    button[disabled] { opacity:0.6; cursor:not-allowed }
    .row { display:flex; gap:12px }
    .col { flex:1 }
    pre { background:#fff; padding:12px; border-radius:6px; overflow:auto }
    img { max-width:100%; border-radius:8px; display:block; margin:10px 0 }
    .error { color:#b00020; font-weight:600 }
    .preview { background:#fff; padding:12px; border-radius:8px; margin-top:12px }
    label { font-weight:600 }
  </style>
</head>
<body>
  <h1>Advanced Content Generator & Publisher</h1>

  <form id="frm">
    <label>Keywords (comma separated)</label>
    <input id="keywords" placeholder="e.g., home workouts, resistance bands" required/>

    <div class="row">
      <div class="col">
        <label>Content Type</label>
        <select id="contentType">
          <option value="blog_post">Blog Post</option>
          <option value="product_review">Product Review</option>
          <option value="affiliate_article">Affiliate Article</option>
        </select>
      </div>
      <div class="col">
        <label>Tone</label>
        <select id="tone">
          <option>friendly</option>
          <option>professional</option>
          <option>casual</option>
          <option>formal</option>
        </select>
      </div>
    </div>

    <label>Target audience</label>
    <input id="audience" placeholder="e.g., beginners, fitness enthusiasts" required/>

    <div class="row">
      <div class="col">
        <label>Word count</label>
        <select id="wordCount">
          <option value="500">500</option>
          <option value="1000">1000</option>
          <option value="1500">1500</option>
        </select>
      </div>
      <div class="col">
        <label>Image prompt (for DALL·E)</label>
        <input id="imagePrompt" placeholder="e.g., A bright CrossFit gym with people training"/>
      </div>
    </div>

    <hr/>

    <label>WordPress auth method</label>
    <select id="wpAuthMethod">
      <option value="app">Application Password (username + app password)</option>
      <option value="jwt">JWT token (Bearer)</option>
    </select>

    <div id="wpAuthApp" style="margin-top:8px">
      <label>WP Username</label>
      <input id="wpUser" placeholder="wp user (for application password)"/>
      <label>WP Application Password</label>
      <input id="wpAppPass" placeholder="app-password (generated in WP user profile)"/>
    </div>

    <div id="wpAuthJwt" style="display:none; margin-top:8px">
      <label>JWT Token</label>
      <input id="wpJwt" placeholder="JWT token (if using JWT auth)"/>
    </div>

    <label>WordPress site URL (example: https://example.com)</label>
    <input id="wpSite" placeholder="https://your-site.com" required />

    <div style="margin-top:8px">
      <button id="generateBtn" type="button">Generate & Preview</button>
      <button id="postBtn" type="button" disabled>Post to WordPress</button>
    </div>
  </form>

  <p id="status" class="error"></p>

  <div class="preview" id="previewArea" style="display:none">
    <h2>Preview</h2>
    <h3 id="previewTitle">—</h3>
    <p><strong>SEO description:</strong> <span id="previewSeo"></span></p>
    <p><strong>Excerpt:</strong> <span id="previewExcerpt"></span></p>
    <p><strong>Tags:</strong> <span id="previewTags"></span></p>
    <div id="imageContainer"></div>
    <div id="articleHtml"></div>
  </div>

  <script>
    // Helper: show/hide WP auth fields
    const wpAuthMethod = document.getElementById('wpAuthMethod');
    const wpAuthApp = document.getElementById('wpAuthApp');
    const wpAuthJwt = document.getElementById('wpAuthJwt');
    wpAuthMethod.addEventListener('change', () => {
      if (wpAuthMethod.value === 'app') { wpAuthApp.style.display = ''; wpAuthJwt.style.display = 'none'; }
      else { wpAuthApp.style.display = 'none'; wpAuthJwt.style.display = ''; }
    });

    const statusEl = document.getElementById('status');
    const generateBtn = document.getElementById('generateBtn');
    const postBtn = document.getElementById('postBtn');

    let currentGenerated = null; // store current preview object

    async function callGenerate() {
      statusEl.textContent = '';
      generateBtn.disabled = true;
      generateBtn.textContent = 'Generating...';

      const payload = {
        keywords: document.getElementById('keywords').value,
        contentType: document.getElementById('contentType').value,
        tone: document.getElementById('tone').value,
        audience: document.getElementById('audience').value,
        wordCount: document.getElementById('wordCount').value,
        imagePrompt: document.getElementById('imagePrompt').value
      };

      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || JSON.stringify(data));

        // data: { title, seo, excerpt, tags:[], html, imageBase64 (optional) }
        currentGenerated = data;
        renderPreview(data);
        postBtn.disabled = false;

      } catch (err) {
        statusEl.textContent = 'Error: ' + (err.message || err);
        currentGenerated = null;
        postBtn.disabled = true;
        document.getElementById('previewArea').style.display = 'none';
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate & Preview';
      }
    }

    function renderPreview(obj) {
      document.getElementById('previewArea').style.display = '';
      document.getElementById('previewTitle').textContent = obj.title || '—';
      document.getElementById('previewSeo').textContent = obj.seo || '—';
      document.getElementById('previewExcerpt').textContent = obj.excerpt || '—';
      document.getElementById('previewTags').textContent = (obj.tags || []).join(', ');
      document.getElementById('articleHtml').innerHTML = obj.html || '';
      const imgCont = document.getElementById('imageContainer');
      imgCont.innerHTML = '';
      if (obj.imageBase64) {
        const img = document.createElement('img');
        img.src = 'data:image/png;base64,' + obj.imageBase64;
        img.alt = 'Generated image';
        imgCont.appendChild(img);
      }
    }

    async function callPost() {
      if (!currentGenerated) { statusEl.textContent = 'Nothing generated to post.'; return; }
      postBtn.disabled = true;
      postBtn.textContent = 'Posting...';
      statusEl.textContent = '';

      // Build auth for WP
      const wpSite = document.getElementById('wpSite').value;
      const method = document.getElementById('wpAuthMethod').value;
      const body = {
        site: wpSite,
        title: currentGenerated.title,
        content: currentGenerated.html,
        excerpt: currentGenerated.excerpt,
        tags: currentGenerated.tags,
        imageBase64: currentGenerated.imageBase64 // optional
      };

      if (method === 'app') {
        body.authMethod = 'app';
        body.wpUser = document.getElementById('wpUser').value;
        body.wpAppPass = document.getElementById('wpAppPass').value;
      } else {
        body.authMethod = 'jwt';
        body.wpJwt = document.getElementById('wpJwt').value;
      }

      try {
        const res = await fetch('/api/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || JSON.stringify(data));
        // success
        statusEl.style.color = 'green';
        statusEl.textContent = 'Posted: ' + data.link;
        // optionally open the link
        window.open(data.link, '_blank');
      } catch (err) {
        statusEl.style.color = '#b00020';
        statusEl.textContent = 'Post error: ' + (err.message || err);
      } finally {
        postBtn.disabled = false;
        postBtn.textContent = 'Post to WordPress';
      }
    }

    generateBtn.addEventListener('click', callGenerate);
    postBtn.addEventListener('click', callPost);
  </script>
</body>
</html>