<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Content Generator & Publisher</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f9f9f9; }
form { background:#fff; padding:20px; border-radius:8px; max-width:600px; }
input, select, button { width:100%; padding:8px; margin:8px 0; }
button { background:#007bff; color:#fff; border:none; cursor:pointer; }
button:disabled { opacity:0.6; cursor:not-allowed; }
.error { color:red; font-weight:bold; }
.preview { background:#fff; padding:15px; border-radius:8px; margin-top:10px; }
img { max-width:100%; border-radius:8px; display:block; margin:10px 0; }
</style>
</head>
<body>
<h1>Advanced Content Generator & Publisher</h1>

<form id="contentForm">
    <label>Keywords</label>
    <input id="keywords" placeholder="e.g., Fitness Tips" required>

    <label>Content Type</label>
    <select id="contentType">
        <option value="blog_post">Blog Post</option>
        <option value="product_review">Product Review</option>
        <option value="affiliate_article">Affiliate Article</option>
    </select>

    <label>Tone</label>
    <select id="tone">
        <option value="formal">Formal</option>
        <option value="casual">Casual</option>
        <option value="friendly">Friendly</option>
        <option value="professional">Professional</option>
    </select>

    <label>Target Audience</label>
    <input id="audience" placeholder="e.g., Beginners, Fitness Enthusiasts" required>

    <label>Word Count</label>
    <select id="wordCount">
        <option value="500">500</option>
        <option value="1000">1000</option>
        <option value="2000">2000+</option>
    </select>

    <label>SEO Keywords</label>
    <input id="seoKeywords" placeholder="e.g., fitness tips, home gym">

    <label>Image Prompt (Optional)</label>
    <input id="imagePrompt" placeholder="Describe the image to generate with AI">

    <hr>

    <label>WordPress Auth Method</label>
    <select id="wpAuthMethod">
        <option value="app">Application Password</option>
        <option value="jwt">JWT Token</option>
    </select>

    <div id="wpAppAuth" style="margin-top:8px">
        <label>WP Username</label>
        <input id="wpUser">
        <label>WP App Password</label>
        <input id="wpAppPass">
    </div>

    <div id="wpJwtAuth" style="display:none; margin-top:8px">
        <label>JWT Token</label>
        <input id="wpJwt">
    </div>

    <label>WordPress Site URL</label>
    <input id="wpSite" placeholder="https://your-site.com">

    <button type="button" id="generateBtn">Generate & Preview</button>
    <button type="button" id="postBtn" disabled>Post to WordPress</button>
</form>

<p id="status" class="error"></p>

<div class="preview" id="previewArea" style="display:none">
    <h2>Preview</h2>
    <h3 id="previewTitle"></h3>
    <p><strong>SEO Description:</strong> <span id="previewSeo"></span></p>
    <p><strong>Excerpt:</strong> <span id="previewExcerpt"></span></p>
    <p><strong>Tags:</strong> <span id="previewTags"></span></p>
    <div id="imageContainer"></div>
    <div id="articleHtml"></div>
</div>

<script>
// Firebase config
const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "cuppashash.firebaseapp.com",
    projectId: "cuppashash",
    storageBucket: "cuppashash.appspot.com",
    messagingSenderId: "604204628087",
    appId: "1:604204628087:web:29f9ada8099680af592e72"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let openAIKey = '';
let wordpressKey = '';

async function fetchKeys() {
    try {
        const doc = await db.collection('api_keys').doc('openai_key').get();
        if (doc.exists) {
            openAIKey = doc.data().key_value;
            wordpressKey = doc.data().wordpress_key;
            console.log('API Keys Loaded', {openAIKey, wordpressKey});
        } else throw new Error('No API keys document found');
    } catch(e) {
        document.getElementById('status').textContent = 'Failed to load API keys: '+e.message;
    }
}

document.addEventListener('DOMContentLoaded', fetchKeys);

// Show/hide WP auth fields
document.getElementById('wpAuthMethod').addEventListener('change', e => {
    if(e.target.value==='app'){
        document.getElementById('wpAppAuth').style.display='';
        document.getElementById('wpJwtAuth').style.display='none';
    } else {
        document.getElementById('wpAppAuth').style.display='none';
        document.getElementById('wpJwtAuth').style.display='';
    }
});

let currentGenerated=null;

async function generateContent() {
    const statusEl=document.getElementById('status');
    statusEl.textContent='';
    document.getElementById('generateBtn').disabled=true;

    const payload={
        keywords: document.getElementById('keywords').value,
        contentType: document.getElementById('contentType').value,
        tone: document.getElementById('tone').value,
        audience: document.getElementById('audience').value,
        wordCount: document.getElementById('wordCount').value,
        seoKeywords: document.getElementById('seoKeywords').value,
        imagePrompt: document.getElementById('imagePrompt').value
    };

    try {
        const prompt=`Write a ${payload.tone} ${payload.contentType.replace("_"," ")} targeting ${payload.audience}. Include keywords: ${payload.keywords}. SEO: ${payload.seoKeywords}. Word count: ${payload.wordCount}. Return JSON {title, seo, excerpt, tags[], html, imageBase64 (optional)}`;

        const res = await fetch('https://api.openai.com/v1/chat/completions',{
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'Authorization':`Bearer ${openAIKey}`
            },
            body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages:[{role:"user", content:prompt}],
                max_tokens:2000
            })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(JSON.stringify(data));

        const messageText=data.choices[0].message.content;
        currentGenerated=JSON.parse(messageText);

        renderPreview(currentGenerated);
        document.getElementById('postBtn').disabled=false;

    } catch(err){
        statusEl.textContent='Error generating: '+err.message;
        document.getElementById('postBtn').disabled=true;
    } finally {
        document.getElementById('generateBtn').disabled=false;
    }
}

function renderPreview(obj){
    document.getElementById('previewArea').style.display='';
    document.getElementById('previewTitle').textContent=obj.title||'—';
    document.getElementById('previewSeo').textContent=obj.seo||'—';
    document.getElementById('previewExcerpt').textContent=obj.excerpt||'—';
    document.getElementById('previewTags').textContent=(obj.tags||[]).join(', ');
    document.getElementById('articleHtml').innerHTML=obj.html||'';
    const imgCont=document.getElementById('imageContainer');
    imgCont.innerHTML='';
    if(obj.imageBase64){
        const img=document.createElement('img');
        img.src='data:image/png;base64,'+obj.imageBase64;
        imgCont.appendChild(img);
    }
}

async function postToWordPress(){
    if(!currentGenerated){document.getElementById('status').textContent='Nothing to post.'; return;}
    const statusEl=document.getElementById('status');
    statusEl.textContent='';
    document.getElementById('postBtn').disabled=true;

    const wpSite=document.getElementById('wpSite').value;
    const method=document.getElementById('wpAuthMethod').value;
    let headers={'Content-Type':'application/json'};
    if(method==='app'){
        const user=document.getElementById('wpUser').value;
        const pass=document.getElementById('wpAppPass').value;
        headers['Authorization']='Basic '+btoa(user+':'+pass);
    } else {
        headers['Authorization']='Bearer '+document.getElementById('wpJwt').value;
    }

    try{
        const res=await fetch(`${wpSite}/wp-json/wp/v2/posts`,{
            method:'POST',
            headers,
            body: JSON.stringify({
                title: currentGenerated.title,
                content: currentGenerated.html,
                excerpt: currentGenerated.excerpt,
                tags: currentGenerated.tags
            })
        });
        const data=await res.json();
        if(!res.ok) throw new Error(JSON.stringify(data));
        statusEl.style.color='green';
        statusEl.textContent='Posted! Link: '+data.link;
        window.open(data.link,'_blank');
    } catch(err){
        statusEl.style.color='red';
        statusEl.textContent='WP Post Error: '+err.message;
    } finally {
        document.getElementById('postBtn').disabled=false;
    }
}

document.getElementById('generateBtn').addEventListener('click', generateContent);
document.getElementById('postBtn').addEventListener('click', postToWordPress);
</script>
</body>
</html>
